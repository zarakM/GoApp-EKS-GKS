version: 2.1
orbs:
  gke: circleci/gcp-gke@1.1.0
  k8s: circleci/kubernetes@0.11.2

jobs:
  containerization:
    machine: true
    steps:
      - checkout
      - run: |
          echo "$dockerhub_pass" | docker login --username zarakmughal --password-stdin

      - run: docker build -t zarakmughal/goapp-cicd:main .

      - run: docker push zarakmughal/goapp-cicd:main

  deploy:
    machine: true
    steps:
      - k8s/install-kubectl
      - run: |
          echo $GCLOUD_SERVICE_KEY | gcloud auth activate-service-account --key-file=-
          gcloud --quiet config set project ${GOOGLE_PROJECT_ID}
          gcloud --quiet config set compute/zone ${GOOGLE_COMPUTE_ZONE}
      - gke/create-cluster:
          additional-args: "--cluster-version=1.16 --enable-ip-alias --num-nodes=1"
          cluster: goapp
          install-kubectl: true
      - gke/create-node-pool:
          additional-args: >-
            --image-type=cos --machine-type=e2-small --num-nodes=1
          cluster: goapp
          node-pool: goapp-node

      - run: gcloud container clusters get-credentials goapp


workflows:
  test:
    jobs:
      # - containerization
      - deploy
      # # - helm