orbs:
  gke: circleci/gcp-gke@1.1.0
version: 2.1
jobs:
  containerization:
    machine: true

    steps:
      - checkout
      - run: |
          echo "$dockerhub_pass" | docker login --username zarakmughal --password-stdin

      - run: docker build -t zarakmughal/goapp-cicd:main .

      - run: docker push zarakmughal/goapp-cicd:main
  deploy:
    machine: true
    steps:
      - gke/create-cluster:
          additional-args: "--cluster-version=1.16 --enable-ip-alias --num-nodes=1"
          cluster: goapp
      - gke/create-node-pool:
          additional-args: >-
            --image-type=cos --no-enable-autoupgrade
            --machine-type=e2-small --num-nodes=1
          cluster: gcp-testing
          node-pool: goapp-node
          

workflows:
  test:
    jobs:
      - containerization
      - deploy 
